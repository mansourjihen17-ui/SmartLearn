
# config/packages/security.yaml
security:
  ######################################################################
  # 1) Hachage des mots de passe
  ######################################################################
  password_hashers:
    Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface: 'auto'
      # (Optionnel) être explicite pour ta classe Users :
    # App\Entity\Users:
    #   algorithm: auto

  ######################################################################
  # 2) Providers — chargement des utilisateurs depuis la base (Doctrine)
  ######################################################################
  providers:
    app_user_provider:
      entity:
        class: App\Entity\Users     # <-- ta classe réelle (au pluriel)
        property: username          # <-- identifiant = "username" (Option B)

  ######################################################################
  # 3) Firewalls — coeur de l’authentification
  ######################################################################
  firewalls:
    # Profiler / assets non sécurisés
    dev:
      pattern: ^/(_(profiler|wdt)|css|images|js)/
      security: false

    main:
      lazy: true
      provider: app_user_provider

      # --- Authentificateur intégré "form_login" ---
      form_login:
        login_path: app_login       # route de login (confirmée par debug:router)
        check_path: app_login       # même route si tu postes sur /login
        enable_csrf: false          # tu ne veux pas de CSRF sur le login
        # Aligner avec ton formulaire Twig (names des inputs) :
        username_parameter: _username   # <-- <input name="_username">
        password_parameter: _password   # <-- <input name="_password">
        # (optionnel) page par défaut si aucune page précédente :
        # default_target_path: app_courses_index

      # Entry point : redirige vers /login pour toute page protégée
      entry_point: form_login

      # --- Déconnexion ---
      logout:
        path: app_logout            # route de logout
        # target: app_homepage      # (optionnel) route après logout

      # (Optionnel) Remember-me
      # remember_me:
      #   secret: '%kernel.secret%'
      #   lifetime: 604800   # 7 jours
      #   always_remember_me: false

  ######################################################################
  # 4) Autorisations (seule la 1ʳᵉ règle qui matche est appliquée)
  ######################################################################
  access_control:
    # Pages publiques (anonymes) — Symfony 6+ : PUBLIC_ACCESS
    - { path: '^/login',         roles: PUBLIC_ACCESS }
    - { path: '^/register',      roles: PUBLIC_ACCESS }
    - { path: '^/verify/email',  roles: PUBLIC_ACCESS }

    # Protéger /courses → redirige vers /login si non connecté
    - { path: '^/courses',       roles: ROLE_USER }

    # Tes autres zones (adapte les rôles selon ton appli)
    - { path: '^/admin',         roles: ROLE_STUDENT }
    - { path: '^/profile',       roles: ROLE_USER }

######################################################################
# 5) Overrides pour l’environnement de test (hash plus léger)
######################################################################
when@test:
  security:
    password_hashers:
      Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface:
        algorithm: auto
        cost: 4
        time_cost: 3
        memory_cost: 10
 